---
/**
 * Header — Navigation minimaliste architecturale
 * Glassmorphism subtil, pas de SVG corners, boutons carres
 */
import Container from '@components/ui/Container.astro';

const pathname = Astro.url.pathname;
const navLinks = [
  { href: '/', label: 'Accueil' },
  { href: '/projets', label: 'Projets' },
  { href: '/expertise', label: 'Expertise' },
  { href: '/a-propos', label: 'A propos' },
  { href: '/contact', label: 'Contact' },
];

function isActive(href: string) {
  if (href === '/') return pathname === '/';
  return pathname.startsWith(href);
}
---

<header
  id="main-nav"
  class="fixed top-0 left-0 right-0 z-sticky transition-all duration-500"
  style="background: rgba(253,251,247,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.06);"
>
  <Container>
    <nav class="flex items-center justify-between h-[88px]">

      {/* Logo */}
      <a href="/" class="font-display text-2xl text-primary-dark hover:opacity-100 relative z-[1050]">
        SB Design
      </a>

      {/* Navigation desktop */}
      <ul class="hidden lg:flex items-center gap-10">
        {navLinks.map((link) => (
          <li>
            <a
              href={link.href}
              class:list={[
                'inline-block overflow-hidden relative group font-heading text-[15px] font-medium transition-opacity duration-300',
                isActive(link.href)
                  ? 'text-accent-brown'
                  : 'text-primary-dark hover:opacity-60',
              ]}
              aria-current={isActive(link.href) ? 'page' : undefined}
            >
              <span class="block transition-transform duration-500 ease-out-quart group-hover:-translate-y-full">
                {link.label}
              </span>
              <span class="block absolute top-full left-0 w-full transition-transform duration-500 ease-out-quart group-hover:-translate-y-full" aria-hidden="true">
                {link.label}
              </span>
            </a>
          </li>
        ))}
      </ul>

      {/* CTA — square architectural */}
      <div class="hidden lg:block">
        <a
          href="/contact"
          class="inline-flex items-center px-7 py-3 bg-primary-dark text-white font-heading text-[15px] font-medium hover:bg-[#333] transition-colors duration-500"
        >
          Demander un devis
        </a>
      </div>

      {/* Hamburger mobile */}
      <button
        id="mobile-menu-toggle"
        class="lg:hidden relative z-[1050] p-2 -mr-2"
        aria-label="Ouvrir le menu"
        aria-expanded="false"
      >
        <div id="menu-icon-open" class="flex flex-col gap-[6px] w-6 transition-all duration-300">
          <span class="block w-full h-[1.5px] bg-primary-dark transition-all duration-300 origin-center" />
          <span class="block w-full h-[1.5px] bg-primary-dark transition-all duration-300" />
          <span class="block w-2/3 h-[1.5px] bg-primary-dark transition-all duration-300 ml-auto origin-center" />
        </div>
        <div id="menu-icon-close" class="hidden">
          <svg class="w-6 h-6 text-primary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
      </button>

    </nav>
  </Container>
</header>

{/* Menu mobile — HORS du header pour eviter le stacking context de backdrop-filter */}
<div
  id="mobile-menu"
  class="lg:hidden"
  style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:1040; background-color:#FDFBF7;"
>
  <div class="flex flex-col items-center justify-center h-full gap-5 md:gap-7 px-6">
    {navLinks.map((link, i) => (
      <a
        href={link.href}
        class:list={[
          'mobile-nav-link font-heading text-[clamp(22px,5vw,36px)] font-light uppercase tracking-[0.15em] transition-all duration-300',
          isActive(link.href)
            ? 'text-accent-brown'
            : 'text-primary-dark hover:text-accent-brown',
        ]}
        data-delay={i}
        style="opacity:0; transform:translateY(16px);"
      >
        {link.label}
      </a>
    ))}
    <div class="mt-4 w-full max-w-xs mobile-nav-link" data-delay="5" style="opacity:0; transform:translateY(16px);">
      <a
        href="/contact"
        class="inline-flex items-center justify-center w-full px-8 py-4 bg-primary-dark text-white font-heading text-[15px] font-medium uppercase tracking-wider hover:bg-accent-brown transition-colors duration-300"
      >
        Demander un devis
      </a>
    </div>
  </div>
</div>

{/* Spacer pour compenser le header fixed */}
<div class="h-[88px]"></div>

<script>
  const toggle = document.getElementById('mobile-menu-toggle');
  const menu = document.getElementById('mobile-menu');
  const iconOpen = document.getElementById('menu-icon-open');
  const iconClose = document.getElementById('menu-icon-close');
  const mobileLinks = document.querySelectorAll('.mobile-nav-link');
  let isMenuOpen = false;

  function closeMenu() {
    if (!menu || !iconOpen || !iconClose || !toggle) return;
    isMenuOpen = false;

    // Fade out links
    mobileLinks.forEach((link) => {
      (link as HTMLElement).style.opacity = '0';
      (link as HTMLElement).style.transform = 'translateY(16px)';
    });

    setTimeout(() => {
      menu.style.display = 'none';
      iconOpen.classList.remove('hidden');
      iconClose.classList.add('hidden');
      toggle.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    }, 300);
  }

  function openMenu() {
    if (!menu || !iconOpen || !iconClose || !toggle) return;
    isMenuOpen = true;

    // Show overlay
    menu.style.display = 'block';
    iconOpen.classList.add('hidden');
    iconClose.classList.remove('hidden');
    toggle.setAttribute('aria-expanded', 'true');
    document.body.style.overflow = 'hidden';

    // Stagger links in
    mobileLinks.forEach((link, i) => {
      const el = link as HTMLElement;
      const delay = parseInt(el.dataset.delay || '0') * 80 + 100;
      setTimeout(() => {
        el.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
      }, delay);
    });
  }

  if (toggle && menu) {
    toggle.addEventListener('click', () => {
      if (isMenuOpen) closeMenu();
      else openMenu();
    });
  }

  // Close menu when clicking a link
  mobileLinks.forEach((link) => {
    link.addEventListener('click', () => closeMenu());
  });

  // Scroll state — border opacity increases on scroll
  const nav = document.getElementById('main-nav');

  if (nav) {
    const onScroll = (scrollY: number) => {
      if (scrollY > 100) {
        nav.style.borderBottomColor = 'rgba(0,0,0,0.12)';
      } else {
        nav.style.borderBottomColor = 'rgba(0,0,0,0.06)';
      }
    };

    const lenis = (window as any).__lenis;
    if (lenis) {
      lenis.on('scroll', (e: any) => onScroll(e.animatedScroll));
    } else {
      window.addEventListener('scroll', () => onScroll(window.scrollY));
    }
  }
</script>
