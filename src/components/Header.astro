---
/**
 * Header — Navigation épurée luxe
 * Position fixed top, fond transparent → warm blur au scroll
 * Liens fins, soulignement or au hover, switcher langue discret
 */
import { t, getLocalizedPath, getLangFromUrl, getBasePathname } from '@i18n/index';
import { locales, localeShortLabels, type Locale } from '@i18n/languages';

interface Props { lang?: Locale; }
const lang = Astro.props.lang ?? getLangFromUrl(Astro.url);

const pathname = Astro.url.pathname;
const basePath = getBasePathname(pathname);

const navLinks = [
  { href: getLocalizedPath('/projets', lang),   label: t('nav', 'projets', lang) },
  { href: getLocalizedPath('/expertise', lang),  label: t('nav', 'studio', lang) },
  { href: getLocalizedPath('/a-propos', lang),   label: t('nav', 'processus', lang) },
  { href: getLocalizedPath('/contact', lang),    label: t('nav', 'contact', lang) },
];

function isActive(href: string) {
  if (href === '/' || href === `/${lang}`) return pathname === '/' || pathname === `/${lang}` || pathname === `/${lang}/`;
  return pathname.startsWith(href);
}
---

<header
  id="main-nav"
  class="fixed top-0 left-0 right-0 z-sticky transition-all duration-500"
>
  <div class="flex items-center justify-between px-6 md:px-10 lg:px-14 py-5 lg:py-6">

    {/* Logo */}
    <a href={getLocalizedPath('/', lang)} class="hover:opacity-100 relative z-[1050] flex flex-col items-start">
      <span class="font-heading text-[22px] md:text-[27px] font-bold lowercase text-primary-dark leading-none tracking-[-0.02em]">sbdesign</span>
      <span class="font-heading text-[12px] md:text-[14px] lowercase text-primary-dark/50 leading-none mt-1 self-end tracking-[0.05em]"><span class="font-light">riv</span><span class="font-bold">iera</span></span>
    </a>

    {/* Navigation desktop — liens simples + langue */}
    <nav class="hidden lg:flex items-center gap-10">

      {navLinks.map((link) => (
        <a
          href={link.href}
          class:list={[
            'group relative font-heading text-[13px] font-medium uppercase tracking-[0.12em] transition-colors duration-300',
            isActive(link.href)
              ? 'text-accent-brown'
              : 'text-primary-dark/70 hover:text-primary-dark',
          ]}
          aria-current={isActive(link.href) ? 'page' : undefined}
        >
          {link.label}
          <span
            class:list={[
              'absolute -bottom-1 left-0 h-px bg-accent-gold transition-all duration-300',
              isActive(link.href) ? 'w-full' : 'w-0 group-hover:w-full',
            ]}
          />
        </a>
      ))}

      {/* Séparateur */}
      <span class="w-px h-4 bg-primary-dark/15" />

      {/* Language switcher */}
      <div class="flex items-center gap-1">
        {locales.map((loc) => (
          <a
            href={getLocalizedPath(basePath || '/', loc)}
            class:list={[
              'px-1.5 py-0.5 font-heading text-[11px] font-semibold uppercase tracking-wider transition-colors duration-300',
              loc === lang
                ? 'text-accent-brown'
                : 'text-primary-dark/30 hover:text-primary-dark/60',
            ]}
            aria-label={`Switch to ${localeShortLabels[loc]}`}
          >
            {localeShortLabels[loc]}
          </a>
        ))}
      </div>

      {/* CTA — lien bordé fin */}
      <a
        href={getLocalizedPath('/contact', lang)}
        class="ml-2 px-6 py-2.5 border border-primary-dark/20 font-heading text-[12px] font-semibold uppercase tracking-[0.15em] text-primary-dark hover:border-accent-gold hover:text-accent-brown transition-all duration-300"
      >
        {t('nav', 'rdv', lang)}
      </a>
    </nav>

    {/* Hamburger mobile */}
    <button
      id="mobile-menu-toggle"
      class="lg:hidden relative z-[1050] p-2 -mr-2"
      aria-label="Ouvrir le menu"
      aria-expanded="false"
    >
      <div id="menu-icon-open" class="flex flex-col gap-[6px] w-6 transition-all duration-300">
        <span class="block w-full h-[1.5px] bg-primary-dark transition-all duration-300 origin-center" />
        <span class="block w-full h-[1.5px] bg-primary-dark transition-all duration-300" />
        <span class="block w-2/3 h-[1.5px] bg-primary-dark transition-all duration-300 ml-auto origin-center" />
      </div>
      <div id="menu-icon-close" class="hidden">
        <svg class="w-6 h-6 text-primary-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </div>
    </button>

  </div>

  {/* Ligne dorée subtile en bas du header au scroll */}
  <div id="nav-border" class="absolute bottom-0 left-0 right-0 h-px bg-accent-gold/0 transition-all duration-500" />
</header>

{/* Menu mobile fullscreen */}
<div
  id="mobile-menu"
  class="lg:hidden"
  style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:1040; background-color:rgba(253,251,247,0.98);"
>
  <div class="flex flex-col items-center justify-center h-full gap-8 px-6">
    <a
      href={getLocalizedPath('/', lang)}
      class="mobile-nav-link font-display text-[clamp(28px,6vw,44px)] font-normal uppercase text-primary-dark/40 hover:text-accent-brown transition-all duration-300"
      data-delay="0"
      style="opacity:0; transform:translateY(16px);"
    >
      {t('nav', 'accueil', lang)}
    </a>
    {navLinks.map((link, i) => (
      <a
        href={link.href}
        class:list={[
          'mobile-nav-link font-display text-[clamp(28px,6vw,44px)] font-normal uppercase transition-all duration-300',
          isActive(link.href)
            ? 'text-accent-brown'
            : 'text-primary-dark/40 hover:text-accent-brown',
        ]}
        data-delay={i + 1}
        style="opacity:0; transform:translateY(16px);"
      >
        {link.label}
      </a>
    ))}

    {/* Séparateur */}
    <div class="w-12 h-px bg-accent-gold/30 my-2 mobile-nav-link" data-delay="5" style="opacity:0; transform:translateY(16px);" />

    {/* Language switcher mobile */}
    <div class="flex items-center gap-6 mobile-nav-link" data-delay="5" style="opacity:0; transform:translateY(16px);">
      {locales.map((loc) => (
        <a
          href={getLocalizedPath(basePath || '/', loc)}
          class:list={[
            'font-heading text-sm font-medium uppercase tracking-[0.15em] transition-all duration-300',
            loc === lang
              ? 'text-accent-brown'
              : 'text-primary-dark/30 hover:text-primary-dark/60',
          ]}
        >
          {localeShortLabels[loc]}
        </a>
      ))}
    </div>

    <div class="mt-2 mobile-nav-link" data-delay="6" style="opacity:0; transform:translateY(16px);">
      <a
        href={getLocalizedPath('/contact', lang)}
        class="inline-flex items-center justify-center px-10 py-4 border border-primary-dark/20 font-heading text-[13px] font-semibold uppercase tracking-[0.15em] text-primary-dark hover:border-accent-gold hover:text-accent-brown transition-all duration-300"
      >
        {t('nav', 'prendreRdv', lang)}
      </a>
    </div>
  </div>
</div>

{/* Spacer pour compenser le header */}
<div class="h-[80px]"></div>

<script>
  const toggle = document.getElementById('mobile-menu-toggle');
  const menu = document.getElementById('mobile-menu');
  const iconOpen = document.getElementById('menu-icon-open');
  const iconClose = document.getElementById('menu-icon-close');
  const mobileLinks = document.querySelectorAll('.mobile-nav-link');
  let isMenuOpen = false;

  function closeMenu() {
    if (!menu || !iconOpen || !iconClose || !toggle) return;
    isMenuOpen = false;

    mobileLinks.forEach((link) => {
      (link as HTMLElement).style.opacity = '0';
      (link as HTMLElement).style.transform = 'translateY(16px)';
    });

    setTimeout(() => {
      menu.style.display = 'none';
      iconOpen.classList.remove('hidden');
      iconClose.classList.add('hidden');
      toggle.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    }, 300);
  }

  function openMenu() {
    if (!menu || !iconOpen || !iconClose || !toggle) return;
    isMenuOpen = true;

    menu.style.display = 'block';
    iconOpen.classList.add('hidden');
    iconClose.classList.remove('hidden');
    toggle.setAttribute('aria-expanded', 'true');
    document.body.style.overflow = 'hidden';

    mobileLinks.forEach((link, i) => {
      const el = link as HTMLElement;
      const delay = parseInt(el.dataset.delay || '0') * 80 + 100;
      setTimeout(() => {
        el.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
      }, delay);
    });
  }

  if (toggle && menu) {
    toggle.addEventListener('click', () => {
      if (isMenuOpen) closeMenu();
      else openMenu();
    });
  }

  mobileLinks.forEach((link) => {
    link.addEventListener('click', () => closeMenu());
  });

  // Scroll state — background + border
  const nav = document.getElementById('main-nav');
  const navBorder = document.getElementById('nav-border');
  if (nav) {
    const onScroll = (scrollY: number) => {
      if (scrollY > 80) {
        nav.style.background = 'rgba(253,251,247,0.95)';
        nav.style.backdropFilter = 'blur(20px)';
        (nav.style as any).webkitBackdropFilter = 'blur(20px)';
        if (navBorder) navBorder.style.background = 'rgba(200,175,130,0.15)';
      } else {
        nav.style.background = 'transparent';
        nav.style.backdropFilter = 'none';
        (nav.style as any).webkitBackdropFilter = 'none';
        if (navBorder) navBorder.style.background = 'transparent';
      }
    };

    const lenis = (window as any).__lenis;
    if (lenis) {
      lenis.on('scroll', (e: any) => onScroll(e.animatedScroll));
    } else {
      window.addEventListener('scroll', () => onScroll(window.scrollY));
    }
  }
</script>
