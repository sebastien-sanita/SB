---
/**
 * Layout principal — Shell HTML5 avec SEO, Header, Footer
 * + Page Loader, Page Border, GSAP/Lenis scripts
 */
import '@/styles/global.css';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import { getLangFromUrl, getHreflangAlternates } from '@i18n/utils';
import type { Locale } from '@i18n/languages';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  class?: string;
  lang?: Locale;
}

const defaultDescriptions: Record<Locale, string> = {
  fr: "SB Design Riviera — Luxury Transformation. Conception et valorisation de résidences secondaires haut de gamme sur la Côte d'Azur.",
  en: "SB Design Riviera — Luxury Transformation. Design and enhancement of high-end secondary residences on the French Riviera.",
  it: "SB Design Riviera — Luxury Transformation. Progettazione e valorizzazione di residenze secondarie di lusso sulla Costa Azzurra.",
};

const currentLang = Astro.props.lang ?? getLangFromUrl(Astro.url);
const {
  title,
  description = defaultDescriptions[currentLang],
  ogImage,
  class: className,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const hreflangAlternates = getHreflangAlternates(Astro.url.pathname, Astro.site?.toString().replace(/\/$/, '') ?? '');
---

<!doctype html>
<html lang={currentLang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL.href} />

    <!-- Hreflang alternates for i18n SEO -->
    {hreflangAlternates.map(({ lang, href }) => (
      <link rel="alternate" hreflang={lang} href={href} />
    ))}
    <link rel="alternate" hreflang="x-default" href={hreflangAlternates.find(a => a.lang === 'fr')?.href ?? canonicalURL.href} />

    <!-- Schema.org LocalBusiness -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "LocalBusiness",
      "name": "SB Design Riviera",
      "description": "Luxury Transformation — Conception et valorisation de résidences secondaires haut de gamme sur la Côte d'Azur.",
      "url": "https://www.sbdesign.fr",
      "telephone": ["+33609459245"],
      "email": "contact@sbdesignriviera.fr",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Chassieu",
        "addressRegion": "Côte d'Azur",
        "addressCountry": "FR"
      },
      "areaServed": [
        {"@type": "AdministrativeArea", "name": "Côte d'Azur"},
        {"@type": "AdministrativeArea", "name": "Var"},
        {"@type": "AdministrativeArea", "name": "Alpes-Maritimes"}
      ],
      "priceRange": "€€€€",
      "openingHours": "Mo-Fr 09:00-18:00",
      "knowsLanguage": ["fr", "en", "it"]
    })} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    {ogImage && <meta property="og:image" content={ogImage} />}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImage && <meta name="twitter:image" content={ogImage} />}

    <!-- Preload fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  </head>

  <body class:list={['bg-background text-text-primary is-loading', className]}>

    <!-- Page Loader — Aker-style entry animation -->
    <div
      id="page-loader"
      class="fixed inset-0 z-[9999] bg-background flex flex-col items-center justify-center"
    >
      <span id="page-loader-logo" class="font-display text-3xl text-primary-dark mb-8">
        SB Design
      </span>
      <div class="w-32 h-px bg-border overflow-hidden">
        <div
          id="page-loader-bar"
          class="w-full h-full bg-accent-gold origin-left"
          style="transform: scaleX(0);"
        ></div>
      </div>
    </div>

    <Header lang={currentLang} />

    <main>
      <slot />
    </main>

    <Footer lang={currentLang} />

    <!-- GSAP + Lenis + Animations -->
    <script>
      import '../scripts/lenis';
      import '../scripts/animations';
      import '../scripts/page-loader';

      // Footer reveal — fixed footer with main scrolling over it
      function initFooterReveal() {
        const footer = document.getElementById('main-footer');
        const main = document.querySelector('main');
        if (footer && main) {
          const footerHeight = footer.offsetHeight;
          (main as HTMLElement).style.marginBottom = `${footerHeight}px`;
        }
      }
      window.addEventListener('load', initFooterReveal);
      window.addEventListener('resize', initFooterReveal);
    </script>
  </body>
</html>
